#!/usr/bin/make -f
export DH_OPTIONS

include /usr/share/dpkg/architecture.mk

# Calculating musl based architecture
MUSL_ARCH=$(DEB_HOST_GNU_CPU)
MUSL_TRIPLE=$(DEB_HOST_GNU_CPU)-linux-musl
GLIBC_TRIPLE=$(DEB_HOST_GNU_CPU)-linux-gnu

ifneq (,$(findstring armel, $(DEB_HOST_ARCH)))
  MUSL_ARCH=arm
  MUSL_TRIPLE=arm-linux-musleabi
  GLIBC_TRIPLE=arm-linux-gnu
endif

ifneq (,$(findstring armhf, $(DEB_HOST_ARCH)))
  MUSL_ARCH=armhf
  MUSL_TRIPLE=arm-linux-musleabihf
  GLIBC_TRIPLE=arm-linux-gnueabihf
endif

ifneq (,$(findstring i386, $(DEB_HOST_ARCH)))
  MUSL_ARCH=i386
  MUSL_TRIPLE=i386-linux-musl
  GLIBC_TRIPLE=i386-linux-gnu
endif
export MUSL_ARCH
export MUSL_TRIPLE
export GLIBC_TRIPLE

# Cross build support
ifeq ($(DEB_BUILD_GNU_TYPE),$(DEB_HOST_GNU_TYPE))  
  CC ?= cc
else
  CC=$(DEB_HOST_GNU_TYPE)-gcc
  CROSS_COMPILE=$(DEB_HOST_GNU_TYPE)-
  export CROSS_COMPILE
endif
export CC

# Clear variables to make musl happy
CFLAGS=
CPPFLAGS=
LDFLAGS=
export CFLAGS
export CPPFLAGS
export LDFLAGS

%:
	dh $@ --parallel

debian/scripts/$(MUSL_TRIPLE).path: debian/scripts/config.path.in
	sed 's/@MUSL_TRIPLE@/$(MUSL_TRIPLE)/g' $< > $@
	cp debian/scripts/$(MUSL_TRIPLE).path debian/scripts/ld-musl-$(MUSL_ARCH).path

override_dh_auto_configure: debian/scripts/$(MUSL_TRIPLE).path
	dh_auto_configure -- --libdir=/usr/lib/$(MUSL_TRIPLE) --includedir=/usr/include/$(MUSL_TRIPLE) --host=$(DEB_HOST_GNU_TYPE)

override_dh_fixperms:
	dh_fixperms --exclude libc.so

